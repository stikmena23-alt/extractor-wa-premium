<!-- index.html -->
<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Extractor WF-TOOLS</title>


<!-- Iconos -->
<link rel="icon" type="image/png" href="WF%20TOOLS 2.png?v=1">
<link rel="apple-touch-icon" href="WF%20TOOLS 2.png?v=1">
<meta name="theme-color" content="#0ea5e9">


  <!-- Estilos -->
  <link rel="stylesheet" href="styles.css"/>
  
</head>
<body class="is-checking-session">
  <div id="sessionLoading" class="session-loading" role="status" aria-live="polite" aria-busy="true">
    <div class="session-loading__spinner" aria-hidden="true"></div>
    <p id="sessionLoadingMessage" class="session-loading__message">Verificando tu sesi√≥n...</p>
    <p class="session-loading__hint">Por favor espera un momento.</p>
  </div>
  <!-- Pantalla de inicio de sesi√≥n -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card-stack">
      <form id="loginForm" class="login-card" data-view="login">
        <h2 class="title-heading">
          <img class="title-logo" src="WF%20TOOLS.png" alt="WF TOOLS">
          <span class="title-text">Bienvenido a WF-TOOLS</span>
        </h2>
        <label class="field">
          <span>Correo/usuario</span>
          <input type="email" id="loginEmail" placeholder="usuario@correo.com" autocomplete="username" autofocus required />
        </label>
        <label class="field password-field">
          <span>Contrase√±a</span>
          <div class="input-affix">
            <input type="password" id="loginPassword" placeholder="Contrase√±a" autocomplete="current-password" required />
            <button type="button" id="loginTogglePassword" class="input-affix__action" aria-label="Mostrar contrase√±a" aria-pressed="false">Mostrar</button>
          </div>
        </label>
        <div class="login-extras">
          <label class="remember-option" for="loginRemember">
            <input type="checkbox" id="loginRemember" />
            <span class="remember-option__decor" aria-hidden="true"></span>
            <span class="remember-option__label">Recordar usuario</span>
          </label>
        </div>
        <button id="loginBtn" class="btn login-primary">Entrar</button>
        <button id="adminPanelBtn" class="btn admin-portal-btn" type="button" hidden>
          <span aria-hidden="true" class="icon">üõ°Ô∏è</span>
          <span>Abrir panel administrador</span>
        </button>
        <!-- Eliminamos el bot√≥n de compra y el texto de WhatsApp.  En su lugar mostramos
             un mensaje que indica al usuario que utilice el bot√≥n flotante de recarga
             ubicado en la esquina inferior izquierda. -->
        <p class="buy-info">Para recargar tu cuenta, utiliza el bot√≥n en la esquina inferior izquierda.</p>
        <div class="login-links">
          <button type="button" id="showRegisterBtn" class="link-button">Registrarme</button>
          <button id="adminAccessBtn" type="button" class="admin-access-link">Ingreso administradoüîí</button>
        </div>
        <p id="loginLoading" class="loading-msg">Iniciando sesi√≥n...</p>
        <p id="loginError" class="error-msg"></p>
      </form>

      <form id="registerForm" class="login-card is-hidden" data-view="register" novalidate>
        <h2 class="title-heading">
          <img class="title-logo" src="WF%20TOOLS.png" alt="WF TOOLS">
          <span class="title-text">Crea tu acceso</span>
        </h2>
        <p class="register-intro">Registra tus datos para generar tu usuario WF TOOLS. Recibir√°s un usuario autom√°tico con el formato <strong>clien.&lt;nombre&gt;@wftools.com</strong>.</p>
        <label class="field">
          <span>Nombre completo</span>
          <input type="text" id="reg_name" placeholder="Ej. Maria Fernanda" autocomplete="name" required />
        </label>
        <label class="field">
          <span>Correo electr√≥nico</span>
          <input type="email" id="reg_email" placeholder="correo@personal.com" autocomplete="email" required />
        </label>
        <label class="field">
          <span>N√∫mero de tel√©fono</span>
          <input type="tel" id="reg_phone" placeholder="3001234567" autocomplete="tel" required />
        </label>
        <label class="field">
          <span>Contrase√±a</span>
          <input type="password" id="reg_password" placeholder="M√≠nimo 8 caracteres" autocomplete="new-password" required />
        </label>
        <p id="registerError" class="error-msg" role="alert"></p>
        <div id="registerSuccess" class="register-success" hidden>
          <h3>Registro completado</h3>
          <p>Tu usuario para WF TOOLS es:</p>
          <div class="register-credentials">
            <div><span>Usuario:</span> <strong id="registerUsername">‚Äî</strong></div>
            <div><span>Correo:</span> <strong id="registerUserEmail">‚Äî</strong></div>
          </div>
          <p class="muted small-note">Usa estas credenciales junto con la contrase√±a creada.</p>
        </div>
        <button id="btnRegister" class="btn login-primary" type="submit">
          <span class="btn-spinner" aria-hidden="true"></span>
          <span class="btn-text">Registrar cuenta</span>
        </button>
        <button type="button" id="btnBackLogin" class="link-button">Volver al inicio de sesi√≥n</button>
      </form>
    </div>
  </div>

  <div id="sessionToast" class="session-toast" role="status" aria-live="polite" aria-hidden="true"></div>

  <div id="sessionModal" class="session-modal" aria-hidden="true" role="dialog" aria-labelledby="sessionModalTitle" aria-describedby="sessionModalMessage">
    <div class="session-modal-card">
      <div class="session-modal-icon" aria-hidden="true">
        <span>‚úì</span>
      </div>
      <h3 id="sessionModalTitle">¬°Sesi√≥n iniciada!</h3>
      <p id="sessionModalMessage">Has iniciado sesi√≥n con √©xito.</p>
      <button id="sessionModalClose" class="btn" type="button">Continuar</button>
    </div>
  </div>

  

  <div class="wrap" id="appWrap" style="display:none;">
    <header class="hero">
      <h1>Extractor WF-TOOLS (WhatsApp,Facebook/Instagram)</h1>
      <p class="sub">Limpia, une y exporta contactos y m√°s ‚ûú XLSX <span class="muted">(+ CSV/JSON opcional)</span></p>
      <p> Versi√≥n 1.2.1 </p>
    </header>

    <!-- Barra superior -->
    <section class="card panel span-12 topbar">
      <div class="row">
        <label class="field small-field">
          <span>Modo</span>
          <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
            <span class="lbl">Claro</span>
          </label>
        </label>

        <label class="field small-field">
          <span>Anonimizar vista previa</span>
          <label class="switch">
            <input type="checkbox" id="anonToggle">
            <span class="slider"></span>
            <span class="lbl">Activar</span>
          </label>
        </label>

        <label class="field small-field">
          <span>Autosave</span>
          <label class="switch">
            <input type="checkbox" id="autosaveToggle" checked>
            <span class="slider"></span>
            <span class="lbl">Activar</span>
          </label>
        </label>

        <div class="row actions one-line">
          <div class="chip" id="planChip" style="display:none;">Plan: <span id="planName">-</span></div>
          <div class="chip" id="creditsChip" style="display:none;">Cr√©ditos: <span id="creditCount">0</span></div>
          <button id="logoutBtn" class="btn danger" style="display:none;">Cerrar sesi√≥n</button>
        </div>
      </div>
    </section>

    <main class="grid">
      <!-- Panel de estado de usuario -->
      <section class="card panel span-12" id="accountPanel">
        <h2>Estado de cuenta</h2>
        <p id="sessionStatusText" class="session-status">Inicia sesi√≥n para ver tu plan y tus cr√©ditos en tiempo real.</p>
        <div class="user-status">
          <div class="user-overview">
            <div class="user-meta">
              <div class="meta-block">
                <span class="meta-label">Nombre</span>
                <span id="currentUserName" class="meta-value">-</span>
              </div>
              <div class="meta-block">
                <span class="meta-label">Usuario / correo</span>
                <span id="currentUserEmail" class="meta-value">-</span>
              </div>
              <div class="meta-block">
                <span class="meta-label">Plan</span>
                <span id="currentUserPlan" class="meta-value">-</span>
              </div>
            </div>
            <div
              id="accountAdminShortcut"
              class="account-admin-shortcut"
              aria-hidden="true"
              hidden
            >
              <div class="account-admin-shortcut__copy">
                <span class="account-admin-shortcut__title">Acceso administrador</span>
                <span class="account-admin-shortcut__hint">Gestiona usuarios, cr√©ditos y reportes desde el panel dedicado.</span>
              </div>
              <button
                id="adminPanelBtnInline"
                class="btn admin-portal-btn"
                type="button"
                aria-hidden="true"
                hidden
              >
                <span aria-hidden="true" class="icon">üõ°Ô∏è</span>
                <span>Abrir panel administrador</span>
              </button>
            </div>
          </div>
          <div class="credit-status" id="creditStatus" data-state="idle">
            <div class="credit-count">Cr√©ditos disponibles: <strong id="currentUserCredits">0</strong></div>
            <div class="credit-bar" id="creditBar" role="progressbar" aria-valuemin="0" aria-valuemax="0" aria-valuenow="0">
              <div id="creditBarFill" class="credit-bar-fill"></div>
            </div>
            <p id="creditAlertMsg" class="credit-alert muted">Inicia sesi√≥n para visualizar tu saldo.</p>
          </div>
        </div>
      </section>

      <!-- Panel entrada -->
      <section class="card panel span-7" id="dropZone">
        <h2>Entrada</h2>
        <p>Pega el texto o arrastra <strong>.txt/.csv/.html</strong> o un <strong>.zip</strong> con <code>records.html</code>. <strong>No</strong> se suben archivos, todo es local.</p>

        <textarea id="inputText" placeholder="Pega aqu√≠ el texto o suelta un archivo..."></textarea>

        <div class="row">
          <label class="field">
            <span>Objetivo (Account Identifier)</span>
            <input type="text" id="accountId" placeholder="Ej: 3001234567"/>
          </label>
          <label class="field">
            <span>Caso / Expediente (opcional)</span>
            <input type="text" id="caseId" placeholder="Ej: 3020912 - Medell√≠n"/>
          </label>
        </div>

        <div class="row actions one-line">
          <button id="uploadBtn" class="btn success">Subir archivo(s)</button>
          <input type="file" id="filePicker" accept=".zip,.txt,.csv,.html,application/zip" multiple style="display:none" />
          <button id="processBtn" class="btn">Procesar texto</button>
          <button id="addToBatchBtn" class="btn yellow">Agregar al lote</button>
          <button id="clearBtn" class="btn danger">Limpiar</button>
        </div>

        <div class="upload-status-panel" id="uploadStatusPanel" aria-live="polite">
          <div class="upload-status-head">
            <h3>Historial de cargas</h3>
            <span id="uploadStatusCounter" class="upload-status-counter">0/10</span>
          </div>
          <div id="uploadStatusList" class="upload-status-list">
            <p class="upload-status-empty">Sin cargas registradas.</p>
          </div>
        </div>
      </section>

      <!-- Vista previa -->
      <section class="card panel span-5">
        <div class="preview-top">
          <div class="preview-head">
            <h2>Vista previa</h2>
            <div class="row small-row">
              <input id="previewFilter" class="mini-input" placeholder="Filtrar..."/>
              <select id="sortSelect" class="mini-input">
                <option value="original">Orden original</option>
                <option value="asc">Ascendente</option>
                <option value="len">Por longitud</option>
              </select>
              <label class="switch">
                <input type="checkbox" id="showAll">
                <span class="slider"></span>
                <span class="lbl">TODO</span>
              </label>
            </div>
          </div>

          <div class="stats">
            <div class="chip">Le√≠dos: <span id="stat-read">0</span></div>
            <div class="chip">√önicos: <span id="stat-unique">0</span></div>
            <div class="chip">Duplicados: <span id="stat-dup">0</span></div>
          </div>
        </div>

        <div id="contactsList" class="preview"></div>
        <div class="mini-dash" id="prefixDash"></div>

        <div class="row actions one-line">
          <label class="switch small">
            <input type="checkbox" id="fmtXlsx" checked>
            <span class="slider"></span><span class="lbl">XLSX</span>
          </label>
          <label class="switch small">
            <input type="checkbox" id="fmtCsv">
            <span class="slider"></span><span class="lbl">CSV</span>
          </label>
          <label class="switch small">
            <input type="checkbox" id="fmtJson">
            <span class="slider"></span><span class="lbl">JSON</span>
          </label>
          <button id="downloadBtn" class="btn" disabled>Descargar (Actual)</button>
        </div>
      </section>

      <!-- Lote -->
      <section class="card panel span-12">
        <h2>Reportes cargados (Lote)</h2>
        <div id="batchList" class="batch"></div>
        <div class="row actions one-line">
          <button id="exportMergedBtn" class="btn" disabled>Descargar (Unificado)</button>
          <button id="clearBatchBtn" class="btn ghost">Vaciar lote</button>
        </div>
      </section>

      <!-- Panel: Informaci√≥n del Dispositivo / Servicio -->
      <section class="card panel span-12" id="deviceInfoCard">
        <h2>Informaci√≥n del servicio, dispositivo e IP</h2>
        <div class="info-grid">
          <div class="kv">
            <div class="k">Inicio del servicio:</div>
            <div class="v" id="serviceStartVal">-</div>
          </div>
          <div class="kv">
            <div class="k">N√∫mero de compilaci√≥n del SO del dispositivo:</div>
            <div class="v" id="osBuildVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Estado de la conexi√≥n:</div>
            <div class="v" id="connStatVal">-</div>
          </div>
          <div class="kv">
            <div class="k">√öltima vez visto:</div>
            <div class="v" id="lastSeenVal">-</div>
            <div class="v" id="lastSeenLabel">-</div>
          </div>
        
          <div class="kv">
            <div class="k">Visto hace:</div>
            <div class="v" id="lastSeenAgoVal">-</div>
          </div>
          <div class="kv">
            <div class="k">√öltima IP:</div>
            <div class="v" id="lastIpVal">-</div>
          </div> 
          <div class="kv">
            <div class="k">Puerto:</div>
            <div class="v" id="ipPortVal">No encontrado</div>
          </div>
          
          <div class="kv">
            <div class="k">ISP:</div>
            <div class="v" id="ispVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Ciudad (estimada):</div>
            <div class="v" id="cityVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Pa√≠s / Bandera:</div>
            <div class="v" id="countryVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Proxy / VPN / Tor:</div>
            <div class="v"><div id="secChips" class="security-chips"></div></div>
          </div>
          <div class="kv">
            <div class="k">Versi√≥n:</div>
            <div class="v" id="ipVersionVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Tipo:</div>
            <div class="v" id="ipTypeVal">-</div>
          </div>
        </div>
        <p class="muted small-note">Fechas ajustadas a UTC‚àí5. <span class="warn-note">‚Äú√öltima vez visto‚Äù en <span class="red">rojo</span> si es anterior a ahora; <span class="green">verde</span> si es igual/posterior.</span></p>
      </section>

      <!-- NUEVO: Tabla residencial (auto) -->
      <section class="card panel span-12 hidden" id="resCard">
        <div class="res-head">
          <h2>IP Residencial ‚Äì Tabla</h2>
          <button id="copyResTableBtn" class="btn outline">Copiar tabla</button>
        </div>
        <div class="table-wrap">
          <table id="resTable" class="table">
            <thead>
              <tr>
                <th>DIRECCION IP</th>
                <th>FECHA Y HORA COLOMBIANA UTC</th>
                <th>FECHA Y HORA COLOMBIANA HLC</th>
                <th>FECHA Y HORA SOLICITADAS</th>
                <th>PUERTO DE CONEXI√ìN</th>
              </tr>
            </thead>
            <tbody id="resTableBody"></tbody>
          </table>
          <div class="small-note muted"> ‚Üí Generada a partir de ‚Äú√öltima IP‚Äù y ‚Äú√öltima vez visto‚Äù (FECHA Y HORA SOLICITADAS HLC: 5 min antes y 5 min despu√©s).</div>
        </div>
      </section>
      <!-- Panel de gr√°fico de conexiones -->
      <section class="card panel span-6" id="graphPanel">
        <div class="graph-top">
          <h2>Relaciones entre lista de contactos (GR√ÅFICOS)</h2>
          <div class="graph-controls">
            <div class="graph-layout-group">
              <label for="graphLayoutSelect" class="graph-label">Organizar</label>
              <select id="graphLayoutSelect" class="mini-input graph-select">
                <option value="free">Autom√°tico</option>
                <option value="hierarchical-lr">Jer√°rquico (Horizontal)</option>
                <option value="hierarchical-ud">Jer√°rquico (Vertical)</option>
              </select>
            </div>
            <div class="graph-button-group">
              <button id="graphRefreshBtn" class="btn graph-refresh" type="button">Reordenar</button>
              <button id="relBtn" class="graph-fullscreen-btn" type="button" aria-pressed="false">
                <span class="icon" aria-hidden="true"></span>
                <span class="text">Pantalla completa</span>
              </button>
            </div>
          </div>
        </div>
        <div class="graph-actions" id="graphActions">
          <div class="graph-selection" id="graphSelectionBox">
            <div class="graph-selection__label" id="graphSelectionLabel">Sin datos disponibles.</div>
            <div class="graph-selection__controls">
              <input type="text" id="graphLabelInput" class="mini-input" placeholder="Etiqueta personalizada" disabled />
              <div class="graph-selection__buttons">
                <button id="graphCopyBtn" class="btn outline" type="button" disabled>Copiar n√∫mero</button>
                <button id="graphLabelSaveBtn" class="btn" type="button" disabled>Guardar etiqueta</button>
                <button id="graphDeleteBtn" class="btn danger" type="button" disabled>Borrar</button>
              </div>
            </div>
          </div>
          <div class="graph-export">
            <button id="graphExportPdfBtn" class="btn outline" type="button" disabled>Exportar PDF</button>
            <button id="graphExportXlsxBtn" class="btn outline" type="button" disabled>Exportar XLSX</button>
          </div>
        </div>
        <div id="graphLegends" class="graph-legends" hidden>
          <p class="graph-legends__title">Leyenda de reportes</p>
          <div id="colorControls" class="color-controls" aria-live="polite"></div>
        </div>
        <div class="graph-stage" id="graphStage">
          <div id="graphLoading" class="graph-loading" role="status" aria-live="polite" hidden>
            <div class="graph-loading__spinner" aria-hidden="true"></div>
            <p class="graph-loading__text">Cargando gr√°fico, por favor espere...</p>
          </div>
          <div id="graph" aria-busy="false"></div>
        </div>
      </section>

      <!-- Panel de chatbot -->
      <section class="card panel span-6" id="chatbotPanel">
        <h2>Chatbot de An√°lisis</h2>
        <div id="chatLog" class="chat-log"></div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Escribe una instrucci√≥n...">
          <button id="chatSend" class="btn">Enviar</button>
        </div>
        <div class="chat-hints">
          <p class="chat-hints-title">Instrucciones sugeridas:</p>
          <ul>
            <li><strong>cuantos</strong> para saber cu√°ntos n√∫meros se han detectado.</li>
            <li><strong>duplicados</strong> para ver cu√°ntos se repiten.</li>
            <li><strong>promedio</strong> y el bot calcular√° la media de los n√∫meros.</li>
            <li><strong>sentimiento</strong> para analizar el tono del texto.</li>
            <li><strong>lote</strong> o <strong>relacion</strong> para resumir coincidencias entre reportes.</li>
            <li>Escribe <strong>ayuda</strong> si quieres volver a ver estas opciones.</li>
          </ul>
        </div>
      </section>

      <!-- Panel de administraci√≥n -->
    </main>

    <footer class="footer">
      <div class="sig">DESARROLLADO POR <strong>DEVINSON MENA</strong></div>
      <div class="links">
        <span>Versi√≥n 1.2.1</span>
        <span class="dot">‚Ä¢</span>
        <a href="mailto:devinson.mena@correo.policia.gov.co" rel="noopener">Contacto</a>
        <span class="dot">‚Ä¢</span>
        <a href="https://github.com/" target="_blank" rel="noopener">Repositorio</a>
        <span class="dot">‚Ä¢</span>
        <a href="#" aria-disabled="true" tabindex="-1" class="muted">Gu√≠a r√°pida</a>
      </div>
      <div class="legal">
        Uso exclusivo para <strong>an√°lisis</strong>. Los datos y resultados generados son
        <strong>responsabilidad del usuario</strong>.
      </div>
      <div class="copy">Colaboradores: Jamer Guzman - Esteban Jimenez</div>
      <div class="copy">¬© 2025 D-TECH SOLUTIONS</div>
    </footer>
  </div>

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sentiment@5.0.2/build/sentiment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- App -->
  <script src="js/app-core.js"></script>
  <script src="js/auth.js"></script>
  <!-- A√±adimos un par√°metro de versi√≥n al script main.js para evitar que los cambios queden en cach√© -->
  <script src="js/main.js?v=2"></script>

  <!--
    Bot√≥n flotante para recargar cr√©ditos.  Se a√±ade al final del cuerpo
    para no interferir con el flujo principal de la aplicaci√≥n.  El bot√≥n
    utiliza los estilos definidos en styles.css y apunta al archivo
    principal unificado (index.html) para mostrar la p√°gina de recarga.
  -->
  <!--
    Contenedor del bot√≥n flotante para WF‚ÄëTOOLS cuando se abre de forma
    independiente (fuera del index unificado).  Incluye el logo encima
    del enlace para que sea m√°s claro y separe el contenido.  El logo
    utiliza un tama√±o fijo y el texto se conserva dentro del enlace.
  -->
  <div id="rechargeWidgetWF" style="position: fixed; bottom: 20px; left: 20px; z-index: 1000; display: flex; flex-direction: column; align-items: center;">
    <!-- Logo SVG de CrediBoost para el bot√≥n flotante local. -->
    <svg width="40" height="40" viewBox="0 0 120 120" role="img" aria-label="Logo CrediBoost" style="margin-bottom: 6px;" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="cbGradientWF" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#21e4ff" />
          <stop offset="100%" stop-color="#6b8cff" />
        </linearGradient>
      </defs>
      <polygon points="60,6 110,36 110,84 60,114 10,84 10,36" fill="url(#cbGradientWF)" />
      <text x="50%" y="56%" text-anchor="middle" font-family="Orbitron, sans-serif" font-size="42" fill="#ffffff">CB</text>
    </svg>
    <a class="floating-btn" href="../index.html" id="rechargeBtnWF">
      <span>Recarga tu cuenta aqu√≠</span>
    </a>
  </div>

  <!-- Script para ocultar el bot√≥n de recarga interno cuando la p√°gina se muestra dentro de un iframe (es decir, en el index unificado).  -->
  <script>
    (function() {
      try {
        if (window.self !== window.top) {
          var widgetWF = document.getElementById('rechargeWidgetWF');
          if (widgetWF) {
            widgetWF.style.display = 'none';
          }
        }
      } catch (err) {
        // en caso de error simplemente no hacemos nada
      }
    })();
  </script>
</body>
</html>
