<!-- index.html -->
<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Extractor Contactos de WhatsApp – Texto a XLSX (v1.2.1)</title>

  <!-- Iconos -->
  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/9445/9445678.png?v=1">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/9445/9445678.png?v=1">
  <meta name="theme-color" content="#0ea5e9">

  <!-- Estilos -->
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <!-- Pantalla de inicio de sesión -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h2>Iniciar sesión</h2>
      <label class="field">
        <span>Correo</span>
        <input type="email" id="loginEmail" />
      </label>
      <label class="field">
        <span>Contraseña</span>
        <input type="password" id="loginPassword" />
      </label>
      <button id="loginBtn" class="btn">Entrar</button>
      <p id="loginError" class="error-msg"></p>
    </div>
  </div>

  <!-- MODAL: Guía -->
  <div id="modalOverlay" class="modal-overlay" aria-hidden="true"></div>
  <div id="howtoModal" class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-desc">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="modal-title">Te voy a enseñar cómo usar la herramienta ↓</h3>
        <button class="modal-close" type="button" aria-label="Cerrar" data-close-howto>×</button>
      </div>
      <div class="modal-body" id="modal-desc">
        <ol>
          <li>Pega texto o arrastra <code>.txt</code>/<code>.csv</code>/<code>.html</code>/<code>.zip</code></li>
          <li>Si es ZIP, buscará <code>records.html</code>; detecta <em>Account Identifier</em> y limpia <code>+57</code> / <code>57</code> / <code>0057</code></li>
          <li>Escribe el <strong>Objetivo</strong> (opcional; se autocompleta si se detecta) y <strong>Caso</strong> (opcional)</li>
          <li>Presiona <strong>Procesar texto</strong></li>
          <li>Usa <strong>filtro</strong>, <strong>ordenamiento</strong> y revisa <strong>duplicados</strong> resaltados</li>
          <li><strong>Agregar al lote</strong> para unir reportes. <strong>Descargar (Actual/Unificado)</strong> crea XLSX + CSV/JSON</li>
          <li>El panel <strong>Relaciones</strong> dibuja el grafo automáticamente; usa <strong>Pantalla completa</strong> para ampliarlo y colorear cada objetivo.</li>
          <li>El panel <strong>Chatbot</strong> responde a “cuantos”, “duplicados”, “promedio”, “sentimiento” o “lote”.</li>
          <li>El panel <strong>Información del Dispositivo / Servicio</strong> se llena automáticamente desde el HTML / texto (UTC−5 y consulta de IP)</li>
        </ol>
        <p class="note"><strong>Nota:</strong> No toma fechas/años (1900–2099), <u>omite</u> “Internal Ticket Number” / “Número de ticket interno” y <u>solo considera números con 8+ dígitos</u>. También excluye el <em>Account Identifier</em> de la lista.</p>
      </div>
      <div class="modal-actions">
        <button class="btn" type="button" data-close-howto>Entiendo</button>
      </div>
    </div>
  </div>

  <div class="wrap" id="appWrap" style="display:none;">
    <header class="hero">
      <h1>Extractor Contactos de WhatsApp Premium</h1>
      <p class="sub">Limpia, une y exporta contactos ➜ XLSX <span class="muted">(+ CSV/JSON opcional)</span></p>
      <p> Versión 1.2.1 </p>
    </header>

    <!-- Barra superior -->
    <section class="card panel span-12 topbar">
      <div class="row">
        <label class="field small-field">
          <span>Modo</span>
          <label class="switch">
            <input type="checkbox" id="themeToggle">
            <span class="slider"></span>
            <span class="lbl">Claro</span>
          </label>
        </label>

        <label class="field small-field">
          <span>Anonimizar vista previa</span>
          <label class="switch">
            <input type="checkbox" id="anonToggle">
            <span class="slider"></span>
            <span class="lbl">Activar</span>
          </label>
        </label>

        <label class="field small-field">
          <span>Autosave</span>
          <label class="switch">
            <input type="checkbox" id="autosaveToggle" checked>
            <span class="slider"></span>
            <span class="lbl">Activar</span>
          </label>
        </label>

        <div class="row actions one-line">
          <button id="openGuide" class="btn ghost">Guía ( ? )</button>
        </div>
      </div>
    </section>

    <main class="grid">
      <!-- Panel entrada -->
      <section class="card panel span-7" id="dropZone">
        <h2>Entrada</h2>
        <p>Pega el texto o arrastra <strong>.txt/.csv/.html</strong> o un <strong>.zip</strong> con <code>records.html</code>. <strong>No</strong> se suben archivos, todo es local.</p>

        <textarea id="inputText" placeholder="Pega aquí el texto o suelta un archivo..."></textarea>

        <div class="row">
          <label class="field">
            <span>Objetivo (Account Identifier)</span>
            <input type="text" id="accountId" placeholder="Ej: 3001234567"/>
          </label>
          <label class="field">
            <span>Caso / Expediente (opcional)</span>
            <input type="text" id="caseId" placeholder="Ej: 3020912 - Medellín"/>
          </label>
        </div>

        <div class="row actions one-line">
          <button id="uploadBtn" class="btn success">Subir archivo(s)</button>
          <input type="file" id="filePicker" accept=".zip,.txt,.csv,.html,application/zip" multiple style="display:none" />
          <button id="processBtn" class="btn">Procesar texto</button>
          <button id="addToBatchBtn" class="btn">Agregar al lote</button>
          <button id="clearBtn" class="btn danger">Limpiar</button>
        </div>
      </section>

      <!-- Vista previa -->
      <section class="card panel span-5">
        <div class="preview-top">
          <div class="preview-head">
            <h2>Vista previa</h2>
            <div class="row small-row">
              <input id="previewFilter" class="mini-input" placeholder="Filtrar..."/>
              <select id="sortSelect" class="mini-input">
                <option value="original">Orden original</option>
                <option value="asc">Ascendente</option>
                <option value="len">Por longitud</option>
              </select>
              <label class="switch">
                <input type="checkbox" id="showAll">
                <span class="slider"></span>
                <span class="lbl">TODO</span>
              </label>
            </div>
          </div>

          <div class="stats">
            <div class="chip">Leídos: <span id="stat-read">0</span></div>
            <div class="chip">Únicos: <span id="stat-unique">0</span></div>
            <div class="chip">Duplicados: <span id="stat-dup">0</span></div>
          </div>
        </div>

        <div id="contactsList" class="preview"></div>
        <div class="mini-dash" id="prefixDash"></div>

        <div class="row actions one-line">
          <label class="switch small">
            <input type="checkbox" id="fmtXlsx" checked>
            <span class="slider"></span><span class="lbl">XLSX</span>
          </label>
          <label class="switch small">
            <input type="checkbox" id="fmtCsv">
            <span class="slider"></span><span class="lbl">CSV</span>
          </label>
          <label class="switch small">
            <input type="checkbox" id="fmtJson">
            <span class="slider"></span><span class="lbl">JSON</span>
          </label>
          <button id="downloadBtn" class="btn" disabled>Descargar (Actual)</button>
        </div>
      </section>

      <!-- Lote -->
      <section class="card panel span-12">
        <h2>Reportes cargados (Lote)</h2>
        <div id="batchList" class="batch"></div>
        <div class="row actions one-line">
          <button id="exportMergedBtn" class="btn" disabled>Descargar (Unificado)</button>
          <button id="clearBatchBtn" class="btn ghost">Vaciar lote</button>
        </div>
      </section>

      <!-- Panel: Información del Dispositivo / Servicio -->
      <section class="card panel span-12" id="deviceInfoCard">
        <h2>Información del servicio, dispositivo e IP</h2>
        <div class="info-grid">
          <div class="kv">
            <div class="k">Inicio del servicio:</div>
            <div class="v" id="serviceStartVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Número de compilación del SO del dispositivo:</div>
            <div class="v" id="osBuildVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Estado de la conexión:</div>
            <div class="v" id="connStatVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Última vez visto:</div>
            <div class="v" id="lastSeenVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Visto hace:</div>
            <div class="v" id="lastSeenAgoVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Última IP:</div>
            <div class="v" id="lastIpVal">-</div>
          </div>
          <div class="kv">
            <div class="k">ISP:</div>
            <div class="v" id="ispVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Ciudad (estimada):</div>
            <div class="v" id="cityVal">-</div>
          </div>
          <div class="kv">
            <div class="k">País / Bandera:</div>
            <div class="v" id="countryVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Proxy / VPN / Tor:</div>
            <div class="v"><div id="secChips" class="security-chips"></div></div>
          </div>
          <div class="kv">
            <div class="k">Versión:</div>
            <div class="v" id="ipVersionVal">-</div>
          </div>
          <div class="kv">
            <div class="k">Tipo:</div>
            <div class="v" id="ipTypeVal">-</div>
          </div>
        </div>
        <p class="muted small-note">Fechas ajustadas a UTC−5. <span class="warn-note">“Última vez visto” en <span class="red">rojo</span> si es anterior a ahora; <span class="green">verde</span> si es igual/posterior.</span></p>
      </section>

      <!-- NUEVO: Tabla residencial (auto) -->
      <section class="card panel span-12 hidden" id="resCard">
        <div class="res-head">
          <h2>IP Residencial – Tabla</h2>
          <button id="copyResTableBtn" class="btn outline">Copiar tabla</button>
        </div>
        <div class="table-wrap">
          <table id="resTable" class="table">
            <thead>
              <tr>
                <th>DIRECCION IP</th>
                <th>FECHA Y HORA COLOMBIANA UTC</th>
                <th>FECHA Y HORA COLOMBIANA HLC</th>
                <th>FECHA Y HORA SOLICITADAS</th>
              </tr>
            </thead>
            <tbody id="resTableBody"></tbody>
          </table>
          <div class="small-note muted"> → Generada a partir de “Última IP” y “Última vez visto” (FECHA Y HORA SOLICITADAS HLC: 5 min antes y 5 min después).</div>
        </div>
      </section>
      <!-- Panel de gráfico de conexiones -->
      <section class="card panel span-6" id="graphPanel">
        <h2>Relaciones</h2>
        <button id="relBtn" class="btn">Pantalla completa</button>
        <div id="colorControls" class="color-controls"></div>
        <div id="graph"></div>
      </section>

      <!-- Panel de chatbot -->
      <section class="card panel span-6" id="chatbotPanel">
        <h2>Chatbot de Análisis</h2>
        <div id="chatLog" class="chat-log"></div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Escribe una instrucción...">
          <button id="chatSend" class="btn">Enviar</button>
        </div>
      </section>

      <!-- Panel de administración -->
      <section class="card panel span-12" id="adminPanel" style="display:none;">
        <h2>Clientes</h2>
        <table class="admin-table" id="clientsTable">
          <thead>
            <tr><th>Cliente</th><th>Créditos</th><th>Acciones</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="row">
          <input id="newClientName" placeholder="Nuevo cliente" />
          <input id="newClientCredits" type="number" placeholder="Créditos" />
          <button id="addClientBtn" class="btn">Agregar</button>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="sig">DESARROLLADO POR <strong>DEVINSON MENA</strong></div>
      <div class="links">
        <span>Versión 1.2.1</span>
        <span class="dot">•</span>
        <a href="mailto:devinson.mena@correo.policia.gov.co" rel="noopener">Contacto</a>
        <span class="dot">•</span>
        <a href="https://github.com/" target="_blank" rel="noopener">Repositorio</a>
        <span class="dot">•</span>
        <a href="#" aria-disabled="true" tabindex="-1" class="muted">Guía rápida</a>
      </div>
      <div class="legal">
        Uso exclusivo para <strong>análisis</strong>. Los datos y resultados generados son
        <strong>responsabilidad del usuario</strong>.
      </div>
      <div class="copy">Colaboradores: Jamer Guzman - Esteban Jimenez</div>
      <div class="copy">© 2025 D-TECH SOLUTIONS</div>
    </footer>
  </div>

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sentiment@5.0.2/build/sentiment.min.js"></script>

  <!-- App -->
  <script src="app.js"></script>
</body>
</html>
