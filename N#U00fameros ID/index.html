<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Open Phone OSINT | WF TOOLS</title>
  <meta name="theme-color" content="#0a0b0f"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet"/>
  <!-- jsPDF para exportación PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
  <!-- libphonenumber-js (parseo offline) -->
  <script src="https://cdn.jsdelivr.net/npm/libphonenumber-js@1.10.25/bundle/libphonenumber-min.js"></script>
  <style>
    :root{ --bg:#0a0b0f; --panel:#0f121a; --card:#0c1117; --text:#e6edf3; --muted:#9aa4b2; --border:#1b2330; --brand:#0ea5e9; --ok:#22c55e; --danger:#ef4444; --blue:#2563eb; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#07090f,#0b0e15 40%,#0a0b0f);color:var(--text);font-family:"Space Grotesk",system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .site-header{display:flex;justify-content:space-between;align-items:center;gap:16px;padding:18px 22px;border-bottom:1px solid var(--border);background:#07090f;position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:46px;height:46px;border-radius:14px;display:grid;place-items:center;font-family:Orbitron,sans-serif;background:var(--brand);color:#001018;font-weight:800;letter-spacing:1px;box-shadow:var(--shadow)}
    .brand .meta h1{margin:0;font-size:1.2rem}
    .brand .meta p{margin:2px 0 0;color:var(--muted);font-size:.9rem}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#16202b;color:var(--muted);font-size:.85rem;border:1px solid var(--border)}
    .container{max-width:1100px;margin:28px auto;padding:0 16px;display:grid;gap:20px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card h2{margin:0 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:8px;min-width:220px}
    .field.full{flex:1}
    input,select,textarea{background:#0b121a;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 12px;outline:none;font-size:1rem}
    textarea{resize:vertical}
    .hint{color:var(--muted);font-size:.9rem}
    .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:transform .05s ease;background:#1b2330;color:var(--text)}
    .btn:active{transform:translateY(1px)}
    .btn.brand{background:var(--brand);color:#001018}
    .btn.ok{background:var(--ok);color:#00150a}
    .btn.danger{background:var(--danger);color:#1a0003}
    .btn.blue{background:var(--blue);color:#eef6ff}
    .btn.muted{background:#16202b;color:var(--muted)}
    .result{margin-top:14px;display:grid;gap:12px}
    .result .cardline{border:1px solid var(--border);background:#0b1117;border-radius:14px;padding:12px}
    .kv{display:grid;grid-template-columns:200px 1fr;gap:10px;padding:6px 0;border-bottom:1px dashed #1a2432}
    .kv:last-child{border-bottom:none}
    .links a{display:inline-block;margin:4px 6px 0 0;padding:6px 10px;border-radius:999px;background:#111a24;border:1px solid #1a2432;color:#cfe7ff;text-decoration:none;font-size:.86rem}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .site-footer{margin:32px 0;text-align:center;color:var(--muted)}
    @media (max-width:900px){.kv{grid-template-columns:140px 1fr}}
  </style>

  <!-- Barra de información de usuario -->
  <style>
    .user-info-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      padding: 12px 16px;
      background: color-mix(in oklab, var(--panel) 92%, var(--text) 8%);
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .user-info-bar span {
      font-weight: 600;
    }
    .user-info-bar b {
      margin-right: 4px;
      font-weight: 600;
      color: var(--muted);
    }

    .no-credits-msg {
      margin-left: 8px;
    }

    /* Centramos el encabezado principal: logo y título en el centro y la pastilla a la derecha */
    .site-header {
      justify-content: center;
      position: relative;
    }
    .site-header > div:last-child {
      position: absolute;
      right: 22px;
      top: 50%;
      transform: translateY(-50%);
    }
    /* Centrar el texto del título y subtítulo */
    .brand .meta h1,
    .brand .meta p {
      text-align: center;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo">WF</div>
      <div class="meta">
        <h1>Open Phone OSINT — Búsqueda</h1>
        <p>Solo HTML/CSS/JS — análisis offline + dorks OSINT</p>
      </div>
    </div>
    <div><span class="pill">Sin APIs</span></div>
  </header>

  <!-- Panel con datos del usuario -->
  <div id="userInfoBar" class="user-info-bar">
    <span><b>Usuario:</b> <span id="uiUserName">—</span></span>
    <span><b>Email:</b> <span id="uiUserEmail">—</span></span>
    <span><b>Plan:</b> <span id="uiUserPlan">—</span></span>
    <span><b>Créditos:</b> <span id="uiUserCredits">—</span></span>
    <!-- Mensaje mostrado cuando no hay créditos -->
    <span id="uiNoCredits" class="no-credits-msg" style="display:none; color: var(--danger); font-weight:600;">Recargar cuenta</span>
    <!-- Botón de cierre de sesión -->
    <button id="uiLogoutBtn" class="btn danger" style="margin-left:auto; padding:6px 12px; font-size:13px; border-radius:10px; cursor:pointer;">Cerrar sesión</button>
  </div>

  <main class="container">
    <section class="card">
      <h2>Ingreso de números</h2>
      <div class="row">
        <label class="field full">
          <span>Números (uno por línea, admite prefijos +E.164 o locales)</span>
          <textarea id="numbers" rows="5" placeholder="+573001112233\n3051234567\n+5215512345678"></textarea>
        </label>
        <label class="field" style="min-width:140px">
          <span>País por defecto</span>
          <select id="country">
            <option value="CO" selected>CO</option>
            <option value="MX">MX</option>
            <option value="US">US</option>
            <option value="IN">IN</option>
            <option value="AR">AR</option>
            <option value="PE">PE</option>
            <option value="CL">CL</option>
          </select>
        </label>
      </div>
      <div class="actions">
        <button class="btn brand" id="btnAnalyze">Analizar</button>
        <button class="btn muted" id="btnClear">Limpiar</button>
      </div>
      <p class="hint">El análisis valida y formatea con <strong>libphonenumber-js</strong> (sin consumir APIs). Se generan enlaces OSINT útiles automáticamente.</p>
    </section>

    <section class="card">
      <h2>Resultados</h2>
      <div id="results" class="result"></div>
      <div class="actions">
        <button class="btn ok" id="btnExportCSV">Exportar CSV</button>
        <button class="btn danger" id="btnExportPDF">Exportar PDF</button>
      </div>
    </section>

    <section class="card">
      <h2>OSINT — Links rápidos</h2>
      <div id="osintLinks" class="result"></div>
      <details style="margin-top:12px">
        <summary class="mono">Ver salida cruda</summary>
        <pre id="rawOut" class="mono" style="background:#081018;border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto"></pre>
      </details>
    </section>

    <section class="card">
      <h2>Ayuda</h2>
      <ul>
        <li><strong>Offline:</strong> detección de país/validez, formateo E.164/internacional/nacional, tipo de línea cuando esté disponible.</li>
        <li><strong>OSINT:</strong> dorks instantáneos: Google, X/Twitter, Facebook, Instagram, TikTok, LinkedIn, Telegram, Skype, WhatsApp.</li>
        <li><strong>Exportación:</strong> CSV y PDF en cliente (no sale del navegador).</li>
      </ul>
    </section>
  </main>

  <footer class="site-footer">© 2025 WF TOOLS — Open Phone OSINT</footer>

  <script>
    const el = s => document.querySelector(s);
    const dedupe = arr => Array.from(new Set(arr.map(s => s.trim()).filter(Boolean)));

    // Parse telefónico offline
    const parsePhone = (raw, country) => {
      try{
        const { parsePhoneNumberFromString } = libphonenumber;
        const p = parsePhoneNumberFromString(String(raw), country);
        if(!p) return null;
        return {
          input: String(raw),
          country: p.country || country || null,
          valid: p.isValid(),
          type: p.getType && p.getType() || null,
          e164: p.format('E.164'),
          international: p.formatInternational(),
          national: p.formatNational(),
          uri: p.getURI && p.getURI() || null
        };
      }catch(e){ return null; }
    };

    function analyzeOffline(numbers, country){
      const out = [];
      for(const n of numbers){
        const r = parsePhone(n, country);
        out.push({ input:n, ...(r || { valid:false, error:'No se pudo parsear' }) });
      }
      return out;
    }

    function renderResults(rows){
      const root = el('#results');
      const rawOut = el('#rawOut');
      root.innerHTML = rows.map((r,i)=>`
        <div class="cardline">
          <div class="kv"><div>#</div><div>${i+1}</div></div>
          <div class="kv"><div>Entrada</div><div class="mono">${r.input||'—'}</div></div>
          <div class="kv"><div>Válido</div><div>${r.valid?'<span class="pill">Sí</span>':'<span class="pill">No</span>'}</div></div>
          <div class="kv"><div>País (detectado)</div><div>${r.country||'—'}</div></div>
          <div class="kv"><div>Tipo</div><div>${r.type||'—'}</div></div>
          <div class="kv"><div>E.164</div><div class="mono">${r.e164||'—'}</div></div>
          <div class="kv"><div>Internacional</div><div class="mono">${r.international||'—'}</div></div>
          <div class="kv"><div>Nacional</div><div class="mono">${r.national||'—'}</div></div>
          ${r.error?`<div class="kv"><div>Error</div><div>${r.error}</div></div>`:''}
        </div>
      `).join('');
      rawOut.textContent = JSON.stringify(rows, null, 2);
    }

    function buildOSINTLinks(numbers){
      const box = el('#osintLinks');
      box.innerHTML = '';
      const link = (txt,url) => `<a href="${url}" target="_blank" rel="noopener">${txt}</a>`;
      const uniq = dedupe(numbers);
      const groups = [];
      uniq.forEach(n => {
        const q = encodeURIComponent(n);
        const clean = String(n).replace(/\D/g,'');
        const links = [
          link('Google', `https://www.google.com/search?q=%22${q}%22`),
          link('Bing', `https://www.bing.com/search?q=%22${q}%22`),
          link('X/Twitter', `https://x.com/search?q=${q}`),
          link('Facebook', `https://www.facebook.com/search/top?q=${q}`),
          link('Instagram', `https://www.instagram.com/explore/search/keyword/?q=${q}`),
          link('TikTok', `https://www.tiktok.com/search?q=${q}`),
          link('LinkedIn', `https://www.linkedin.com/search/results/all/?keywords=${q}`),
          link('Telegram', `https://t.me/${clean}`),
          link('Skype', `skype:${clean}?call`),
          link('WhatsApp wa.me', `https://wa.me/${clean}`),
          link('DuckDuckGo', `https://duckduckgo.com/?q=%22${q}%22`)
        ];
        groups.push(`
          <div class="cardline">
            <div class="kv"><div>Número</div><div class="mono">${n}</div></div>
            <div class="links">${links.join('')}</div>
          </div>`);
      });
      box.innerHTML = groups.join('');
    }

    // CSV
    function csvEscape(v){ if(v==null) return ''; const s=String(v); return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s; }
    function exportCSV(rows){
      const header=['index','input','valid','country','type','e164','international','national'];
      const lines=[header.join(',')];
      rows.forEach((r,i)=>{
        lines.push([i+1,r.input||'',r.valid?'1':'0',r.country||'',r.type||'',r.e164||'',r.international||'',r.national||''].map(csvEscape).join(','));
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='open_phone_osint.csv'; a.click();
    }

    // PDF
    async function exportPDF(rows){
      if(!rows?.length){ alert('No hay resultados para exportar'); return; }
      const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit:'pt', format:'a4' });
      const margin=40, lineH=16; let y=margin;
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text('Open Phone OSINT — Reporte', margin, y); y+=lineH;
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(`Generado: ${new Date().toLocaleString()}`, margin, y); y+=lineH;
      const note='Validación y formato con libphonenumber-js (offline). No se usan APIs.';
      const lines=doc.splitTextToSize(note, 515); doc.text(lines, margin, y); y+=lines.length*12+8;
      doc.setFontSize(12);
      rows.forEach((r,idx)=>{
        const block=[`#${idx+1}`,`Entrada: ${r.input||'—'}`,`Válido: ${r.valid?'Sí':'No'}`,`País: ${r.country||'—'}`,`Tipo: ${r.type||'—'}`,`E.164: ${r.e164||'—'}`,`Intern.: ${r.international||'—'}`,`Nacional: ${r.national||'—'}`].join('\n');
        const bl=doc.splitTextToSize(block, 515);
        if(y+bl.length*lineH>(842-margin)){ doc.addPage(); y=margin; }
        doc.text(bl, margin, y); y+=bl.length*lineH+8;
      });
      doc.save('open_phone_osint.pdf');
    }

    // Eventos
    el('#btnAnalyze').addEventListener('click', ()=>{
      const raw=(el('#numbers').value||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const numbers=dedupe(raw);
      const country=el('#country').value || 'CO';
      const rows=analyzeOffline(numbers, country);
      window.__rows=rows; renderResults(rows); buildOSINTLinks(rows.map(r=>r.e164||r.input));
    });

    el('#btnClear').addEventListener('click', ()=>{
      el('#numbers').value=''; el('#results').innerHTML=''; el('#rawOut').textContent=''; el('#osintLinks').innerHTML=''; window.__rows=[];
    });

    el('#btnExportCSV').addEventListener('click', ()=>{ exportCSV(window.__rows||[]); });
    el('#btnExportPDF').addEventListener('click', ()=>{ exportPDF(window.__rows||[]); });
  </script>

  <!-- Script de integración con WF-TOOLS para panel de usuario y créditos -->
  <script>
    (function(){
      // Solicita información del usuario al cargarse
      try {
        window.parent.postMessage({ type: 'wftools-request-user-info' }, '*');
      } catch(_e) {}

      // Escucha mensajes desde el index unificado
      window.addEventListener('message', function(event){
        if (!event.data || typeof event.data !== 'object') return;
        const type = event.data.type;
        const nameEl    = document.getElementById('uiUserName');
        const emailEl   = document.getElementById('uiUserEmail');
        const planEl    = document.getElementById('uiUserPlan');
        const creditsEl = document.getElementById('uiUserCredits');
        const noCreditsEl = document.getElementById('uiNoCredits');
        const analyzeBtn = document.getElementById('btnAnalyze');
        if (type === 'wftools-user-info') {
          // Actualiza los datos del usuario y controla créditos
          const name = event.data.name || '—';
          const email = event.data.email || '—';
          const plan = event.data.plan || '—';
          let creditsVal = event.data.credits;
          let credits = (creditsVal !== undefined && creditsVal !== null) ? creditsVal : '—';
          if (nameEl) nameEl.textContent = name;
          if (emailEl) emailEl.textContent = email;
          if (planEl) planEl.textContent = plan;
          // Formatea créditos para mostrarlos con separador de miles
          let displayCredits = credits;
          const numCred = parseInt(credits, 10);
          if (Number.isFinite(numCred)) {
            displayCredits = numCred.toLocaleString('es-CO');
          }
          if (creditsEl) creditsEl.textContent = displayCredits;
          // Habilita o deshabilita el botón según créditos
          const num = parseInt(credits, 10);
          if (!Number.isFinite(num) || num <= 0) {
            if (noCreditsEl) noCreditsEl.style.display = 'inline';
            if (analyzeBtn) analyzeBtn.disabled = true;
          } else {
            if (noCreditsEl) noCreditsEl.style.display = 'none';
            if (analyzeBtn) analyzeBtn.disabled = false;
          }
        } else if (type === 'wftools-logout') {
          // Restablece el panel al cerrar sesión
          ['uiUserName','uiUserEmail','uiUserPlan','uiUserCredits'].forEach(function(id){
            const el = document.getElementById(id);
            if (el) el.textContent = '—';
          });
          if (noCreditsEl) noCreditsEl.style.display = 'none';
          if (analyzeBtn) analyzeBtn.disabled = true;
        }
      });

      // Función para consumir créditos usando el frame de WF-TOOLS
      async function spendCredits(n) {
        try {
          const parentDoc = window.parent.document;
          const wfFrame = parentDoc.getElementById('wfFrame');
          if (wfFrame && wfFrame.contentWindow && wfFrame.contentWindow.Auth && typeof wfFrame.contentWindow.Auth.spendCredit === 'function') {
            for (let i = 0; i < n; i++) {
              const ok = await wfFrame.contentWindow.Auth.spendCredit();
              if (!ok) return false;
            }
            // Solicita actualización inmediata de créditos al índice principal
            try {
              window.parent.postMessage({ type: 'wftools-request-user-info' }, '*');
            } catch(_e) {}
            return true;
          }
        } catch(err) {
          console.error('Error al consumir créditos:', err);
        }
        return true;
      }

      // Reemplaza el handler del botón Analizar para descontar 1 crédito antes del análisis
      const analyzeBtn = document.getElementById('btnAnalyze');
      if (analyzeBtn) {
        const originalHandler = analyzeBtn.onclick || null;
        // Buscamos event listener existente (delegado via addEventListener) 
        // y lo reemplazamos manualmente
        analyzeBtn.addEventListener('click', async function(e){
          // Capturamos el click antes que otros manejadores para consumir crédito
          e.preventDefault();
          // Evitar que otros listeners se ejecuten
          e.stopImmediatePropagation();
          const ok = await spendCredits(1);
          if (!ok) {
            alert('No tienes créditos suficientes para esta consulta.');
            return;
          }
          // Ejecuta la lógica de análisis original
          const raw=(document.querySelector('#numbers').value||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
          const numbers=dedupe(raw);
          const country=document.querySelector('#country').value || 'CO';
          const rows=analyzeOffline(numbers, country);
          window.__rows=rows; renderResults(rows); buildOSINTLinks(rows.map(r=>r.e164||r.input));
        }, true);
      }

      // Maneja el botón de cierre de sesión (en la barra de usuario)
      const uiLogoutBtn = document.getElementById('uiLogoutBtn');
      if (uiLogoutBtn) {
        uiLogoutBtn.addEventListener('click', function() {
          try {
            const parentDoc = window.parent.document;
            const wfFrame = parentDoc.getElementById('wfFrame');
            if (wfFrame && wfFrame.contentWindow && wfFrame.contentWindow.document) {
              const logoutEl = wfFrame.contentWindow.document.getElementById('logoutBtn');
              if (logoutEl && typeof logoutEl.click === 'function') {
                logoutEl.click();
              }
            }
          } catch(err) {
            console.error('Error al cerrar sesión:', err);
          }
        });
      }
    })();
  </script>
</body>
</html>
