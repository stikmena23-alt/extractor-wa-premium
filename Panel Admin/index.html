<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WF-TOOLS ADMIN</title>

  <!-- ‚úÖ Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="WF TOOLS.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="WF TOOLS.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="WF TOOLS.png?v=1" />
  <meta name="theme-color" content="#0a0b0f" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Orbitron:wght@500;700&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="styles.css" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="../WF-TOOLS/js/session-utils.js"></script>
  <script src="app.js" defer></script>
</head>
<body>
  <div class="wrap">
    <div id="sessionOverlay" class="session-overlay" aria-hidden="true">
      <div class="session-box">
        <div class="loader" aria-hidden="true"></div>
        <span class="session-message">Gestionando sesi√≥n‚Ä¶</span>
      </div>
    </div>

    <!-- LOGIN VIEW -->
    <section id="loginView" class="card view active" data-display="flex">
      <div class="brand">
        <div class="logo">
          <img id="loginLogo" alt="WF TOOLS logo" />
        </div>
        <h1>Acceso ‚Äî Administradores</h1>
        <div class="muted">WF-TOOLS<strong></strong></div>
      </div>
      <div class="field">
        <label>Correo/usuario</label>
        <input id="email" class="input" type="email" placeholder="admin@tudominio.com" autocomplete="username" />
      </div>
      <div class="field password-field">
        <label>Contrase√±a</label>
        <div class="input-wrap">
          <input
            id="password"
            class="input"
            type="password"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            autocomplete="current-password"
          />
          <button id="togglePassword" type="button" class="password-toggle" aria-pressed="false">
            <span class="icon" aria-hidden="true">üëÅÔ∏è</span>
            <span class="toggle-text">Mostrar</span>
          </button>
        </div>
      </div>
      <div class="login-options">
        <label class="remember" for="rememberUser">
          <input id="rememberUser" type="checkbox" />
          <span>Recordar correo</span>
        </label>
      </div>
      <button id="btnLogin" class="btn btn-primary">
        <span class="btn-text">Entrar</span>
        <span class="btn-spinner" style="display:none">‚è≥ Iniciando sesi√≥n‚Ä¶</span>
      </button>
      <button id="btnLoginGoClient" class="btn btn-admin-portal" type="button">
        <span class="icon" aria-hidden="true">üõ†Ô∏è</span>
        <span>Abrir WF-TOOLS</span>
      </button>
      <div class="row login-actions" style="margin-top:10px">
        <span id="loginHint" class="hint">Zona de administradores WF-TOOLS</span>
      </div>
      <div id="loginError" class="error" style="display:none"></div>
    </section>

    <!-- ADMIN VIEW -->
    <section id="adminView" class="card view" data-display="block" style="display:none">
      <header class="header">
        <div class="title">
          <div class="logo">
            <img id="headerLogo" alt="WF TOOLS logo" />
          </div>
          <div>
            <h2>Panel Administraci√≥n</h2>
            <div class="pill">Gesti√≥n de usuarios (Supabase)</div>
          </div>
        </div>
        <div class="toolbar">
          <div class="search">
            <input id="q" class="input" placeholder="Buscar por email o nombre" />
            <button id="btnSearch" class="btn btn-search"><span class="icon">üîç</span><span>Buscar</span></button>
          </div>

          <!-- ‚úÖ NUEVO: banda con el usuario logueado justo debajo del buscador -->
          <div id="currentUserBox" class="current-user" aria-live="polite" style="display:none">
            <span class="cu-title">Administrador conectado:</span>
            <span id="cuName" class="cu-name">‚Äî</span>
            <span class="cu-sep">‚Ä¢</span>
            <span id="cuEmail" class="cu-email">‚Äî</span>
          </div>

          <button id="btnGoClient" class="btn btn-admin-portal"><span class="icon" aria-hidden="true">üõ†Ô∏è</span><span>Abrir WF-TOOLS</span></button>
          <button id="btnReload" class="btn btn-reload"><span class="icon">üîÑ</span><span>Recargar</span></button>
          <button id="btnLogout" class="btn btn-logout"><span class="icon">‚úñÔ∏è</span><span>Salir</span></button>
        </div>
      </header>

      <section id="accountPanel" class="account-panel" style="display:none">
        <div class="account-card">
          <div class="account-card__head">
            <div>
              <h3>Estado de cuenta</h3>
              <p class="muted">Resumen del administrador conectado</p>
            </div>
            <span class="account-card__tag" id="accountStatusTag">Activo</span>
          </div>
          <div class="account-card__body">
            <div class="account-user">
              <div class="account-user__icon" aria-hidden="true">üõ°Ô∏è</div>
              <div class="account-user__info">
                <div id="accountUserName" class="account-user__name">‚Äî</div>
                <div id="accountUserEmail" class="account-user__email">‚Äî</div>
              </div>
            </div>
            <div class="account-metrics">
              <div class="account-metric">
                <span class="label">Valor cr√©ditos (COP)</span>
                <strong id="accountTotalCredits">$0</strong>
                <span id="accountTotalCreditsDetail" class="sub">0 cr√©ditos clientes</span>
              </div>
              <div class="account-metric">
                <span class="label">Cuentas activas</span>
                <strong id="accountActiveCount">0</strong>
              </div>
              <div class="account-metric">
                <span class="label">Alertas</span>
                <strong id="accountAlerts">0</strong>
              </div>
            </div>
            <div class="account-actions">
              <button id="btnReviewAlerts" class="btn btn-ghost btn-sm account-action">
                <span class="icon" aria-hidden="true">‚ö†Ô∏è</span>
                <span>Revisar alertas</span>
              </button>
              <button id="btnDownloadReport" class="btn btn-primary btn-sm account-action">
                <span class="icon" aria-hidden="true">üìä</span>
                <span>Generar reporte XLSX</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <div class="panel">
        <div id="creditSummary" class="stats" style="display:none"></div>
        <div id="overlay" class="overlay"><div class="spinner">üîÑ Cargando usuarios‚Ä¶</div></div>

        <div id="skeleton" style="display:none">
          <div class="skeleton"></div>
          <div class="skeleton"></div>
          <div class="skeleton"></div>
        </div>

        <!-- Desktop table -->
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:44px"></th>
                <th>Email</th>
                <th>Nombre</th>
                <th>Plan</th>
                <th>Cr√©ditos</th>
                <th>ID</th>
                <th style="width:300px">Acciones</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <!-- Mobile cards -->
        <div id="cards" class="cards"></div>

        <div id="empty" class="empty" style="display:none">No hay usuarios para mostrar</div>

        <div class="pager">
          <button id="prev" class="btn btn-ghost btn-sm">‚óÄ</button>
          <span id="pageInfo" class="muted">P√°gina 1</span>
          <button id="next" class="btn btn-ghost btn-sm">‚ñ∂</button>
        </div>
      </div>
    </section>

    <!-- MODAL EDIT -->
    <div id="modal" class="modal" role="dialog" aria-modal="true">
      <div class="content">
        <div class="head">
          <strong>Editar usuario</strong>
          <button id="closeModal" class="btn btn-ghost btn-sm">‚úï</button>
        </div>
        <div class="body">
          <div class="field">
            <label>Correo</label>
            <input id="m_email" class="input" type="email" required placeholder="usuario@correo.com" />
            <div id="m_email_err" class="msg-inline" style="display:none; color:var(--danger)">El email es obligatorio.</div>
          </div>
          <div class="field">
            <label>Nombre</label>
            <input id="m_name" class="input" type="text" />
          </div>
          <div class="row">
            <div class="field" style="flex:1">
              <label>Plan</label>
              <select id="m_plan" class="input">
                <option>B√°sico</option>
                <option>Avanzado</option>
                <option>√âlite</option>
              </select>
            </div>
            <div class="field" style="flex:1">
              <label>Cr√©ditos</label>
              <input id="m_credits" class="input" type="number" min="0" />
            </div>
          </div>
          <div class="sep"></div>
          <div class="field">
            <label>Nueva contrase√±a (opcional)</label>
            <input id="m_password" class="input" type="password" placeholder="Dejar vac√≠o para no cambiar" />
            <div id="m_pwd_err" class="msg-inline" style="display:none; color:var(--danger)">La contrase√±a debe tener al menos 12 caracteres.</div>
          </div>
          <div class="hint">Tambi√©n puedes enviar un link de recuperaci√≥n (no ve la contrase√±a).</div>
        </div>
        <div class="foot">
          <button id="btnRecovery" class="btn btn-ghost">Enviar link de recuperaci√≥n</button>
          <button id="btnSave" class="btn btn-primary">Guardar cambios</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
